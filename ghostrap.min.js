/*!
 * ghostrap v1.0.0 - Observe the object property getter, setter or method calls and add custom behavior.
 * Copyright (c) 2015 polygon planet <polygon.planet.aqua@gmail.com>
 * @license MIT
 */
!function(a,b,c){"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports?module.exports=c():exports[a]=c():"function"==typeof define&&define.amd?define(c):b[a]=c()}("ghostrap",this,function(){"use strict";function a(a){this.init(a)}function b(b){return null!=this&&this instanceof a?this:new a(b)}function c(a,b){var c=Object.getOwnPropertyDescriptor(a.target,b);if(!c)return!1;var g=a.traps[b]||(a.traps[b]={});if(g.trapped)return!0;var h=a.handlers[b]||(a.handlers[b]={});g.value=g.prevValue=g.originalValue=a.target[b],g.originalDesc=c,g.restore=function(){delete a.target[b],i(g.originalValue)?a.target[b]=g.originalValue:(Object.defineProperty(a.target,b,g.originalDesc),i(g.value)||g.value===g.originalValue||(a.target[b]=g.value))};var j=f("get",c,function(){return g.value}),k=f("set",c,function(a){return g.value=a}),m=e(g.value),n=function(){Object.defineProperty(a.target,b,{get:g.get,set:g.set})},o=function(c,d,e,f){if(l(h,d))for(var g=h[d],i=0,j=g.length;j>i;i++)e=g[i].call(c,a.target,b,e,f);return e},p=function(c,d){delete a.target[b],a.target[b]=g.value=j();try{return d.call(c)}catch(e){if(e!==q)throw e}finally{n()}},q={};return d(g,{get:function(){return p(this,function(){return o(this,"beforeget",g.value),g.value=j(),g.value=o(this,"get",g.value),g.value})},set:function(c){return p(this,function(){if(o(this,"beforeset",c),k(c),c=j(),c=o(this,"set",c),g.prevValue!==c&&o(this,"change",c),g.value=g.prevValue=c,i(g.value))throw m=e(g.value),a.target[b]=g.value=g.applyFn,q;return g.value})},applyFn:function(){var a,b=arguments;return o(this,"beforeapply",a,b),a=m.apply(this,b),o(this,"apply",a,b)}}),i(g.value)?a.target[b]=g.applyFn:n(),g.trapped=!0}function d(a){return k(arguments,1).forEach(function(b){for(var c,d=Object.keys(b),e=0,f=d.length;f>e;e++)c=d[e],a[c]=b[c]}),a}function e(a){return i(a)?function(){return a.apply(this,arguments)}:function(){return a}}function f(a,b,c){return b[a]&&e(b[a])||i(b.value)&&e(b.value)||c}function g(a,b){var c,d=!1;return function(){if(d)return c;try{return c=a.apply(this,arguments)}finally{d=!0,a=null,b&&b.apply(this,arguments)}}}function h(a){for(var b=Object.keys(a),c=0,d=b.length;d>c;c++)delete a[b[c]];return a}function i(a){return"function"==typeof a}var j,k=Array.prototype.slice.call.bind(Array.prototype.slice),l=Object.prototype.hasOwnProperty.call.bind(Object.prototype.hasOwnProperty);a.prototype={events:null,init:function(a){if(!a)throw new Error("ghostrap requires more than 1 arguments");return j&&j.has(a)?this.events=j.get(a):(this.events={traps:{},target:a,handlers:{}},j||(j=m()),j.set(a,this.events)),this},on:function(a,b){this._once&&(b=g(b,function(){this.off(a,b)}.bind(this)),delete this._once);var d=this.events;if(!d.target)throw new Error("Target is not defined");var e=a.split(":"),f=e[0].toLowerCase(),h=e[1];if(!l(d.traps,h)&&(d.traps[h]={},d.handlers[h]={},!c(d,h)))throw new Error("Failed to set handler");var i=d.handlers[h];return i[f]||(i[f]=[]),i[f].push(b),this},once:function(a,b){return this._once=!0,this.on(a,b)},off:function(a,b){var c=this.events;if(0===arguments.length){var d=c.target;return this.clear(),this.init(d),this}var e=a.split(":"),f=e[0].toLowerCase(),g=e[1],h=c.handlers[g];if(h){var i=h[f];i&&i.length>0&&(null==b?i.length=0:h[f]=i.filter(function(a){return a!==b})),i&&0===i.length&&delete h[f]}return this},clear:function(){var a=this.events;return Object.keys(a.traps).forEach(function(b){var c=a.traps[b];c&&c.restore&&c.restore()}),a.trapper&&h(a.trapper),h(a.traps),h(a.handlers),j["delete"](a.target),a.target=null,this}};var m;return m="undefined"!=typeof WeakMap?function(){return new WeakMap}:function(){function a(){this._id=["","WeakMap",Date.now(),Math.random()].join(".")}return a.prototype={set:function(a,b){Object.defineProperty(a,this._id,{configurable:!0,value:b})},get:function(a){return a[this._id]},has:function(a){return l(a,this._id)},"delete":function(a){return delete a[this._id]}},function(){return new a}}(),b});